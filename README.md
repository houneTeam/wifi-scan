# Wi‑Fi Passive Scanner — README

**Язык:** Русский  
**Файл:** `wifi_scanner.py` — пассивный сканер Wi‑Fi (monitor mode) с фокусным захватом клиентов, логированием и поддержкой OUI/vendor lookup.

---

## Краткое описание

Скрипт выполняет два этапа:

1. **Survey (обзор):** собирает информацию об обнаруженных точках доступа — SSID, BSSID, канал, диапазон (2.4G/5G), уровень сигнала и примерное число наблюдаемых клиентов. Выполняется с **channel hopping** (всех выбранных каналов) или последовательно по каналам.

2. **Focus (фокус-скан):** после выбора AP скрипт фиксируется на его канале и делает углублённый захват (Association/Data/EAPOL/Probe и пр.), чтобы максимально точно собрать MAC клиентов, probe‑запросы и выявить мультикаст/широковещательные адреса.

Дополнительно:
- Запись PCAP (survey и focus) при желании.
- Скачивание `manuf` (список OUI → vendor от Wireshark) и локальный кэш вендоров.
- Сохранение результатов (CSV/JSON/PCAP/manuf) в папку `log/YYYY-MM-DD_HH-MM-SS/`.
- Поддержка последовательного сканирования (`--hop-mode seq`) или обычного хоппера (`--hop-mode hopper`).
- Опции для «щадящей» привязки клиентов (`--lenient-clients`) и сканирования всех BSSID для одного SSID (`--focus-ssid-all`).

---

## Требования

На машине (рассчитано на Linux, тестировано на Kali):

- Права `sudo` (нужен доступ для переключения интерфейса в monitor mode и захвата пакетов).
- Утилиты: `iw` (и `ip` обычно из `iproute2`).
- Python 3.8+
- Пакеты Python:
  ```bash
  sudo pip3 install scapy prettytable
  ```
- Опционально, для более точной подписи вендоров: доступ в интернет для скачивания `manuf` (Wireshark), либо локальный файл `manuf`.

> Аппаратно: Wi‑Fi адаптер должен поддерживать режим monitor и ручную смену канала (наряду с драйвером). Совместимость зависит от драйвера. Примеры:
> - Alfa AWUS1900 — часто использует Realtek RTL8814AU; для него может потребоваться внешний dkms-драйвер (rtl8814au). На Raspberry Pi Zero потребуется USB OTG и стабильное питание; Pi Zero ограничен по CPU, но захват пакетов возможен (время на обработку и запись PCAP может увеличиться).

---

## Установка

1. Склонируй репозиторий / размести `wifi_scanner.py` в рабочей папке:
   ```bash
   git clone <repo>   # или просто разместить файл в папке
   cd wifi-scan
   ```

2. Установи зависимости:
   ```bash
   sudo apt update
   sudo apt install -y iw iproute2
   sudo pip3 install scapy prettytable
   ```

3. (Опционально) скачай `manuf` заранее:
   ```bash
   curl -L -o ./manuf https://www.wireshark.org/download/automated/data/manuf
   ```

---

## Быстрый пример запуска

Простейший обзор 20 секунд (каналы по умолчанию — 2.4G + 5G без DFS):

```bash
sudo python3 wifi_scanner.py -i wlan0 -t 20 --band all
```

С записью PCAPы и скачиванием manuf:

```bash
sudo python3 wifi_scanner.py -i wlan0   -t 25 --band all --include-dfs   --download-manuf --manuf-url https://www.wireshark.org/download/automated/data/manuf   --pcap survey_all.pcap --focus-pcap focus.pcap   --focus-time 120 --focus-ssid-all
```

- Все выходные файлы окажутся в автоматически созданной папке `log/YYYY-MM-DD_HH-MM-SS/`.
- Если укажешь `--pcap survey_all.pcap`, имя будет размещено внутри папки логов.

---

## Подробнее: параметры

```
-i, --iface            интерфейс (например wlan0)
-t, --sniff-time       время survey (секунды), по умолчанию 20
--focus-time           время фокус-скана (сек), по умолчанию 30
--band {24,5,all,custom}
--include-dfs          включать DFS каналы (для 5GHz/all)
--channels             пользовательские каналы (например "1,6,11,36")
--hop-interval         интервал хоппера (сек), по умолчанию 0.35
--hop-mode {hopper,seq}  режим хопинга; "seq" — по одному каналу последовательно (полезно для focus)
--pcap <path>          записывать survey PCAP
--focus-pcap <path>    записывать focus PCAP
--no-auto-monitor      не переводить iface в monitor (предполагается, что он уже в monitor)
--keep-monitor         не возвращать интерфейс в managed при выходе

--download-manuf       скачать manuf (wireshark)
--manuf-url <url>      URL для manuf (по умолчанию официальный)
--oui-manuf <path>     использовать локальный файл manuf

--lenient-clients      более "снисходительная" логика связывания client <-> AP
--focus-ssid-all       при фокусе — сканировать все BSSID с тем же SSID (2.4 и 5GHz)
```

---

## Где сохраняются результаты

При старте создаётся папка:
```
log/YYYY-MM-DD_HH-MM-SS/
```

В неё попадают:
- `survey_all.pcap` (если указано `--pcap`)
- `focus.pcap` (если указано `--focus-pcap`)
- `aps.csv`, `aps.json` — таблица обнаруженных AP
- `clients.csv`, `clients.json` — найденные клиенты (unicast), probe‑запросы и group/broadcast
- `manuf` — если скачан
- (возможные будущие логи)

---

## Пояснения и советы по точности поиска клиентов

1. **Пассивный метод** — скрипт видит только те устройства, которые передают кадры в эфире. Если клиент «молчит» (не передаёт), он не будет обнаружен пассивно. Фокус-скан увеличивает вероятность, так как фиксируемся на канале AP и ждём ассоциаций/данных/EAPOL.

2. **Диапазоны 2.4 vs 5 GHz** — многие роутеры имеют BSSID в обеих полосах. Пользователи могут быть подключены к 2.4G или 5G. Используй `--focus-ssid-all` чтобы просканировать и собрать клиентов по всем BSSID одного SSID.

3. **MAC randomization / locally administered** — современные ОС часто используют случайные локально-адресованные MAC (LA bit set). По OUI такие адреса не распознаются. В списке клиентов они могут отображаться без vendor‑подписи.

4. **Multicast / broadcast & special MACs** — адреса типа `01:00:5e:...` или `33:33:...` — это не пользователи, а мульткасты/групповые адреса. Скрипт помечает такие MAC в отдельной части вывода и в CSV помечаются как `multicast`/`broadcast`.

5. **Драйвер/адаптер** — корректная работа требует, чтобы адаптер поддерживал monitor mode и ручное выставление канала (при помощи `iw`). На некоторых чипсетах (особенно некоторых Realtek) поведение может быть нестабильным — придётся устанавливать сторонние драйверы.

6. **Raspberry Pi Zero + AWUS1900** — теоретически возможно, но учти:
   - Pi Zero ограничен по CPU/IO — запись больших PCAP и длительные sniff могут нагружать устройство.
   - AWUS1900 (RTL8814AU) часто требует внешнего DKMS-драйвера (rtl8814au) и правильной конфигурации; без него monitor/setting channel может некорректно работать.
   - Нужен USB OTG кабель/адаптер и стабильное питание.

---

## Частые проблемы и отладка

- `iw dev wlan0 scan` возвращает ошибки — убедись, что интерфейс в managed и у тебя есть права root.
- `Socket ... failed with '[Errno 100] Network is down'` — иногда появляется при переключении режимов; убедись, что интерфейс поднят (`ip link set wlan0 up`) и драйвер стабилен.
- Если `manuf` не скачивается с основного URL — используй зеркало GitLab (скрипт пробует его автоматически), или скачай вручную и указать `--oui-manuf ./manuf`.
- Низкая детекция клиентов — увеличь `--focus-time`, включи `--lenient-clients` и/или `--focus-ssid-all`. Для 5GHz рекомендуется длиннее слушать, т.к. устройства могут реже передавать и каналы шире.

---

## Пример полного запуска (рекомендация)

```bash
sudo python3 wifi_scanner.py -i wlan0   --download-manuf --manuf-url https://www.wireshark.org/download/automated/data/manuf   --oui-manuf ./manuf   -t 30 --band all --include-dfs   --hop-mode seq   --pcap survey_all.pcap --focus-pcap focus.pcap   --lenient-clients   --focus-ssid-all   --focus-time 120
```

---

## Лицензия и безопасность

- Используй этот инструмент только на оборудовании и сетях, к которым у тебя есть разрешение. Захват чужого трафика и вмешательство в сети без разрешения — незаконно.
- Скрипт демонстрационный; используй на свой страх и риск. Я не несу ответственности за последствия использования.

---

## Контакты / дальнейшие улучшения

Если нужно:
- Разбить проект на модули/пакет (modules: `hopping.py`, `capture.py`, `vendor.py`, `cli.py`) — могу помочь.
- Добавить output/GUI/серверную часть (REST) — тоже можно.
- Автоматическое перемещение старых файлов в лог (архивирование) — опция `--archive-old`.

---
